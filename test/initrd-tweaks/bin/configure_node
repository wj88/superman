#!/bin/sh

supermanid=$1

echo Configuring network settings...
#sleep 2

# Configure the hostname
echo superman-${supermanid} >/etc/hostname
/bin/hostname -F /etc/hostname

# Bring up the network
ip addr add 127.0.0.1/24 broadcast 127.0.0.255 dev lo label lo
ip addr add 10.0.0.${supermanid}/24 broadcast 10.0.0.255 dev eth0 label eth0
ip link set dev eth0 mtu 2500
ip link set lo up
ip link set eth0 up

# Bring up the network
while ! cat /sys/class/net/eth0/operstate | grep "up" > /dev/null; do
	sleep .1
done

# Configue routing
ip route add 10.0.0.1 dev eth0
case ${supermanid} in
2)
	ip route add 10.0.0.3 dev eth0
	ip route add 10.0.0.4 via 10.0.0.3
	;;
3)
	ip route add 10.0.0.2 dev eth0
	ip route add 10.0.0.4 dev eth0
	;;
4)
	ip route add 10.0.0.2 via 10.0.0.3
	ip route add 10.0.0.3 dev eth0
	;;
esac

# Enable IP forwarding
echo 1 >/proc/sys/net/ipv4/ip_forward

# Configure our security credentials
echo Generating the nodes security certificate...
openssl genpkey -paramfile /etc/superman/dh_params.pem -out /etc/superman/superman-${supermanid}_dh_privatekey.pem
openssl pkey -in /etc/superman/superman-${supermanid}_dh_privatekey.pem -pubout -out /etc/superman/superman-${supermanid}_dh_publickey.pem
openssl genrsa -out /etc/superman/superman-${supermanid}_rsa_privatekey.pem 1024
openssl req -new -subj "/C=UK/ST=London/L=Greenwich/O=University of Greenwich/OU=Faculty of Engineering and Science/CN=superman-${supermanid}.fes.gre.ac.uk" -key /etc/superman/superman-${supermanid}_rsa_privatekey.pem -out /etc/superman/superman-${supermanid}_rsa_certreq.csr
openssl x509 -req -in /etc/superman/superman-${supermanid}_rsa_certreq.csr -CAkey /etc/superman/ca_privatekey.pem -CA /etc/superman/ca_certificate.pem -force_pubkey /etc/superman/superman-${supermanid}_dh_publickey.pem -out /etc/superman/superman-${supermanid}_certificate.pem

# Bring up the SUPERMAN kernel-module and daemon
superman-up
